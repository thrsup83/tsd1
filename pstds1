$TimeFrameInDays = 30
$CutOffDate = (Get-Date).AddDays(-$TimeFrameInDays)

$TargetUserRights = @(
    "SeServiceLogonRight", # Log on as a service
    "SeBatchLogonRight"    # Log on as a batch job
)

$RelevantEventIDs = 4704, 4705

Write-Host "Searching Security Event Log for events ID $RelevantEventIDs since $($CutOffDate.ToString('yyyy-MM-dd HH:mm:ss')) (Total $TimeFrameInDays days)..." -ForegroundColor Yellow

$EventData = try {
    Get-WinEvent -LogName Security -FilterHashTable @{
        StartTime = $CutOffDate
        ID = $RelevantEventIDs
    } -ErrorAction Stop
}
catch {
    Write-Error "Error retrieving events. Ensure the Security log is accessible and 'Audit Policy Change' is enabled."
    return
}

# Filtering events that specifically mention the target logon rights
$FilteredEvents = $EventData | Where-Object {
    $EventData -ne $null -and $_.Properties.Count -gt 3 -and ($_.Message -match "SeServiceLogonRight" -or $_.Message -match "SeBatchLogonRight")
} | Select-Object TimeCreated, ID, @{Name='ModifiedByPrincipal';Expression={$_.Properties[3].Value}}, @{Name='TargetAccount';Expression={$_.Properties[2].Value}}, @{Name='UserRight';Expression={$_.Properties[0].Value}}, Message

if ($FilteredEvents.Count -gt 0) {
    Write-Host "`n--- Found Relevant User Right Assignment/Removal Events ---" -ForegroundColor Green
    
    $FilteredEvents | Select-Object TimeCreated, ID, ModifiedByPrincipal, TargetAccount, UserRight, @{N='Action';E={
        if ($_.ID -eq 4704) {"ASSIGNED"}
        elseif ($_.ID -eq 4705) {"REMOVED"}
        else {"N/A"}
    }} | Sort-Object TimeCreated | Format-Table -AutoSize
}
else {
    Write-Host "`nNo relevant events (4704 or 4705) found in the Security log for the last $TimeFrameInDays days regarding Service/Batch logon rights." -ForegroundColor Cyan
}

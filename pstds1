$Accounts = @(
  "DOMAIN\svc_account1",
  "DOMAIN\svc_account2"
)

$LookbackDays = 14
$WindowMinutes = 30

Write-Host "=== SeBatchLogonRight check ==="

$cfg = Join-Path $env:TEMP ("ur_{0}.cfg" -f ([guid]::NewGuid().ToString("N")))
try {
  secedit /export /cfg "$cfg" /areas USER_RIGHTS /quiet | Out-Null
} catch {
  Write-Host "FAILED: secedit export: $($_.Exception.Message)" -ForegroundColor Red
  return
}

$lines = Get-Content $cfg -ErrorAction SilentlyContinue
$batchLine = $lines | Where-Object { $_ -match '^SeBatchLogonRight\s*=' } | Select-Object -First 1
$servLine  = $lines | Where-Object { $_ -match '^SeServiceLogonRight\s*=' } | Select-Object -First 1

Write-Host ("SeBatchLogonRight: " + ($batchLine ? $batchLine : "<missing>"))
Write-Host ("SeServiceLogonRight: " + ($servLine ? $servLine : "<missing>"))

if (-not $batchLine) {
  Write-Host "No SeBatchLogonRight line found in export." -ForegroundColor Yellow
}

foreach ($acct in $Accounts) {
  try {
    $sid = (New-Object System.Security.Principal.NTAccount($acct)).Translate([System.Security.Principal.SecurityIdentifier]).Value
    $inBatch = $false
    if ($batchLine) { $inBatch = ($batchLine -match [regex]::Escape("*$sid")) }
    if ($inBatch) {
      Write-Host ("OK   acct={0} sid={1}" -f $acct, $sid) -ForegroundColor Green
    } else {
      Write-Host ("MISS acct={0} sid={1}" -f $acct, $sid) -ForegroundColor Red
    }
  } catch {
    Write-Host ("FAIL acct={0} sid=<translate_fail>" -f $acct) -ForegroundColor Yellow
  }
}

Remove-Item $cfg -Force -ErrorAction SilentlyContinue

Write-Host ""
Write-Host "=== Looking for LAST policy change event (4704/4705) for SeBatchLogonRight (last $LookbackDays days) ==="

$change = $null
try {
  $evs = Get-WinEvent -FilterHashtable @{ LogName='Security'; StartTime=(Get-Date).AddDays(-$LookbackDays); Id=4704,4705 } -ErrorAction Stop
  foreach ($ev in ($evs | Sort-Object TimeCreated -Descending)) {
    $x = [xml]$ev.ToXml()
    $d = @{}
    foreach($n in $x.Event.EventData.Data){ $d[$n.Name] = $n.'#text' }

    $ur = $d.UserRight
    if (-not $ur) { $ur = $d.PrivilegeList }

    if ($ur -and $ur -match "SeBatchLogonRight") {
      $subject = if($d.SubjectUserName){
        if($d.SubjectDomainName){"$($d.SubjectDomainName)\$($d.SubjectUserName)"} else {$d.SubjectUserName}
      } elseif($d.SubjectUserSid){ $d.SubjectUserSid } else { "<empty>" }

      $change = [pscustomobject]@{
        Time    = $ev.TimeCreated
        Id      = $ev.Id
        Subject = $subject
        Right   = $ur
        First   = (($ev.Message -split "`n")[0]).Trim()
      }
      break
    }
  }
} catch {
  Write-Host "Could not query Security log (permissions/audit). $($_.Exception.Message)" -ForegroundColor Yellow
}

if ($change) {
  Write-Host ("FOUND last change: {0}  id={1}  subject={2}" -f $change.Time, $change.Id, $change.Subject) -ForegroundColor Cyan
  Write-Host ("Right: " + $change.Right)
  Write-Host ("Msg : " + $change.First)
  $pivot = $change.Time
} else {
  Write-Host "NOT FOUND (maybe auditing not enabled for this, or no changes in period)." -ForegroundColor Yellow
  $db = Get-Item "$env:windir\security\Database\secedit.sdb" -ErrorAction SilentlyContinue
  if ($db) {
    $pivot = $db.LastWriteTime
    Write-Host ("Fallback pivot time = secedit.sdb LastWriteTime: {0}" -f $pivot) -ForegroundColor Gray
  } else {
    Write-Host "No pivot time available (no change event and no secedit.sdb)." -ForegroundColor Red
    return
  }
}

$start = $pivot.AddMinutes(-$WindowMinutes)
$end   = $pivot.AddMinutes($WindowMinutes)

Write-Host ""
Write-Host ("=== Window: {0} -> {1} ===" -f $start, $end)

Write-Host ""
Write-Host "=== Security 4688 (process creation) in window (filtered) ==="
try {
  $p4688 = Get-WinEvent -FilterHashtable @{ LogName='Security'; StartTime=$start; EndTime=$end; Id=4688 } -ErrorAction Stop
  $rows = foreach ($ev in ($p4688 | Sort-Object TimeCreated)) {
    $x = [xml]$ev.ToXml()
    $d = @{}
    foreach($n in $x.Event.EventData.Data){ $d[$n.Name] = $n.'#text' }

    $proc = $d.NewProcessName
    $cmd  = $d.CommandLine

    if ($proc -match 'secedit\.exe|sc\.exe|powershell\.exe|cmd\.exe|gpupdate\.exe|mmc\.exe|svchost\.exe' -or
        ($cmd  -match 'secedit|ntrights|sebatchlogonright|gpttmpl|cedit|security policy|user rights')) {
      [pscustomobject]@{
        Time = $ev.TimeCreated
        Proc = $proc
        Cmd  = $cmd
      }
    }
  }
  if ($rows) {
    $rows | Select-Object -First 20 | Format-Table -AutoSize
  } else {
    Write-Host "No matching 4688 events (or 4688 auditing not enabled)." -ForegroundColor Gray
  }
} catch {
  Write-Host "4688 query failed (audit may be off). $($_.Exception.Message)" -ForegroundColor Gray
}

Write-Host ""
Write-Host "=== TaskScheduler/Operational in window (top) ==="
try {
  $tsk = Get-WinEvent -FilterHashtable @{ LogName='Microsoft-Windows-TaskScheduler/Operational'; StartTime=$start; EndTime=$end } -ErrorAction Stop
  $rows = foreach ($ev in ($tsk | Sort-Object TimeCreated)) {
    $x = [xml]$ev.ToXml()
    $d = @{}
    foreach($n in $x.Event.EventData.Data){ $d[$n.Name] = $n.'#text' }

    if ($d.TaskName) {
      [pscustomobject]@{
        Time = $ev.TimeCreated
        Id   = $ev.Id
        Task = $d.TaskName
        Rc   = $d.ResultCode
      }
    }
  }
  if ($rows) {
    $rows | Select-Object -First 25 | Format-Table -AutoSize
  } else {
    Write-Host "No task events in window (or log disabled)." -ForegroundColor Gray
  }
} catch {
  Write-Host "TaskScheduler log query failed (maybe disabled). $($_.Exception.Message)" -ForegroundColor Gray
}

Write-Host ""
Write-Host "=== System (GroupPolicy/SceCli/SCM) in window ==="
try {
  $sys = Get-WinEvent -FilterHashtable @{ LogName='System'; StartTime=$start; EndTime=$end } -ErrorAction Stop |
         Where-Object { $_.ProviderName -in 'Microsoft-Windows-GroupPolicy','SceCli','Service Control Manager' } |
         Sort-Object TimeCreated

  if ($sys) {
    $sys | Select-Object -First 25 TimeCreated, ProviderName, Id, @{n='First';e={ (($_.Message -split "`n")[0]).Trim() }} |
      Format-Table -AutoSize
  } else {
    Write-Host "No System hits from these providers in window." -ForegroundColor Gray
  }
} catch {
  Write-Host "System query failed. $($_.Exception.Message)" -ForegroundColor Gray
}

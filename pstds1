$ErrorActionPreference = "SilentlyContinue"
$WorkDir = "C:\temp\25-12-12"

if (-not (Test-Path -Path $WorkDir)) {
    New-Item -ItemType Directory -Path $WorkDir -Force | Out-Null
}

$XmlPath = "$WorkDir\GpoReport_$(Get-Random).xml"

Write-Host "--- GPO Analysis: Logon Rights & Startup Scripts ---" -ForegroundColor Yellow

Start-Process -FilePath "gpresult" -ArgumentList "/SCOPE COMPUTER /X `"$XmlPath`" /F" -Wait -NoNewWindow

if (-not (Test-Path $XmlPath)) {
    Write-Error "Failed to generate GPO report. Ensure you are running as Administrator."
    exit
}

[xml]$GpoXml = Get-Content $XmlPath

$SecurityExtension = $GpoXml.Rsop.ComputerResults.ExtensionData | Where-Object { $_.Name -eq "Security" }
$UserRights = $SecurityExtension.Extension.UserRightsAssignment

$Targets = @("SeServiceLogonRight", "SeBatchLogonRight")

Write-Host "`n[ User Rights Assignment Analysis ]" -ForegroundColor Gray

foreach ($Right in $Targets) {
    $FoundSetting = $UserRights | Where-Object { $_.Name -eq $Right }
    
    if ($FoundSetting) {
        $GpoName = $FoundSetting.SourceGPO.Name
        if (-not $GpoName) { $GpoName = "Local Policy / Undefined Name" }
        
        Write-Host "$Right" -NoNewline
        Write-Host " is controlled by GPO: " -NoNewline -ForegroundColor White
        Write-Host "$GpoName" -ForegroundColor Red
        
        $Accounts = $FoundSetting.AccountList | ForEach-Object { $_.Name }
        Write-Host "   -> Enforced Accounts: $($Accounts -join ', ')" -ForegroundColor Cyan
    } else {
        Write-Host "$Right" -NoNewline
        Write-Host " is NOT controlled by any Domain GPO (Local Policy Applies)." -ForegroundColor Green
    }
}

$ScriptExtension = $GpoXml.Rsop.ComputerResults.ExtensionData | Where-Object { $_.Name -eq "Scripts" }
$StartupScripts = $ScriptExtension.Extension.Script | Where-Object { $_.Type -eq "Startup" }

Write-Host "`n[ Startup Scripts Analysis ]" -ForegroundColor Gray

if ($StartupScripts) {
    foreach ($Script in $StartupScripts) {
        $SourceGPO = $Script.SourceGPO.Name
        $Cmd = $Script.Command
        $Params = $Script.Parameters
        
        Write-Host "Found Startup Script in GPO: " -NoNewline
        Write-Host "$SourceGPO" -ForegroundColor Red
        Write-Host "   -> Command: $Cmd $Params" -ForegroundColor Cyan
    }
} else {
    Write-Host "No GPO-based Startup Scripts detected." -ForegroundColor Green
}

Remove-Item $XmlPath -Force

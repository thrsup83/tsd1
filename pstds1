$OutDir = "C:\temp\25-12-12"
New-Item -ItemType Directory -Force -Path $OutDir | Out-Null

$Accounts = @(
  "DOMAIN\svc_account1",
  "DOMAIN\svc_account2"
)

$LookbackDays = 7

$ts = Get-Date -Format "yyyyMMdd_HHmmss"
$cn = $env:COMPUTERNAME

$summary = Join-Path $OutDir "sum_${cn}_$ts.txt"
$cfgPath = Join-Path $OutDir "ur_${cn}_$ts.cfg"
$secCsv  = Join-Path $OutDir "sec_${cn}_$ts.csv"
$taskCsv = Join-Path $OutDir "task_${cn}_$ts.csv"
$sysCsv  = Join-Path $OutDir "sys_${cn}_$ts.csv"
$lastPtr = Join-Path $OutDir "last_run.txt"

function W([string]$s="") { Add-Content -Path $summary -Value $s }

W "host=$cn time=$(Get-Date -Format s) user=$env:USERDOMAIN\$env:USERNAME"
try { W "boot=$((Get-CimInstance Win32_OperatingSystem).LastBootUpTime)" } catch {}

$dbPath  = Join-Path $env:windir "security\Database\secedit.sdb"
$slPath  = Join-Path $env:windir "security\logs\scesrv.log"
$db = Get-Item $dbPath -ErrorAction SilentlyContinue
$sl = Get-Item $slPath -ErrorAction SilentlyContinue

if ($db) { W "secedit_sdb=$($db.LastWriteTime.ToString('s')) len=$($db.Length)" } else { W "secedit_sdb=missing" }
if ($sl) { W "scesrv_log=$($sl.LastWriteTime.ToString('s')) len=$($sl.Length)" } else { W "scesrv_log=missing" }

try {
  secedit /export /cfg "$cfgPath" /areas USER_RIGHTS /quiet | Out-Null
  W "export_user_rights=ok path=$cfgPath"
} catch {
  W "export_user_rights=fail err=$($_.Exception.Message)"
}

$batchLine = $null
$servLine  = $null

if (Test-Path $cfgPath) {
  $lines = Get-Content $cfgPath -ErrorAction SilentlyContinue
  $batchLine = $lines | Where-Object { $_ -match '^SeBatchLogonRight\s*=' } | Select-Object -First 1
  $servLine  = $lines | Where-Object { $_ -match '^SeServiceLogonRight\s*=' } | Select-Object -First 1
}

if ($batchLine) { W ("SeBatchLogonRight_raw=" + $batchLine) } else { W "SeBatchLogonRight_raw=<missing>" }
if ($servLine)  { W ("SeServiceLogonRight_raw=" + $servLine)  } else { W "SeServiceLogonRight_raw=<missing>" }

$missingAny = $false
if ($Accounts.Count -gt 0 -and $batchLine) {
  foreach ($acct in $Accounts) {
    try {
      $sid = (New-Object System.Security.Principal.NTAccount($acct)).Translate([System.Security.Principal.SecurityIdentifier]).Value
      $inBatch = ($batchLine -match [regex]::Escape("*$sid"))
      if (-not $inBatch) { $missingAny = $true }
      W "acct=$acct sid=$sid in_batch=$inBatch"
    } catch {
      $missingAny = $true
      W "acct=$acct sid=<translate_fail> in_batch=<unknown>"
    }
  }
}

$changeTime = $null
$changeSrc  = $null

$sec470x = @()
try {
  $sec470x = Get-WinEvent -FilterHashtable @{
    LogName   = 'Security'
    StartTime = (Get-Date).AddDays(-$LookbackDays)
    Id        = 4704,4705
  } -ErrorAction Stop
} catch {}

$hits470x = @()
if ($sec470x.Count -gt 0) {
  foreach ($ev in $sec470x) {
    try {
      $x = [xml]$ev.ToXml()
      $d = @{}
      foreach($n in $x.Event.EventData.Data){ $d[$n.Name] = $n.'#text' }
      $ur = $d.UserRight
      if (-not $ur) { $ur = $d.PrivilegeList }
      if ($ur -and $ur -match "SeBatchLogonRight") {
        $subj = if($d.SubjectUserName){
          if($d.SubjectDomainName){"$($d.SubjectDomainName)\$($d.SubjectUserName)"} else {$d.SubjectUserName}
        } elseif($d.SubjectUserSid){ $d.SubjectUserSid } else { "" }

        $hits470x += [pscustomobject]@{
          TimeCreated = $ev.TimeCreated
          Id          = $ev.Id
          Subject     = $subj
          UserRight   = $ur
          FirstLine   = (($ev.Message -split "`n")[0]).Trim()
        }
      }
    } catch {}
  }
}

if ($hits470x.Count -gt 0) {
  $last = $hits470x | Sort-Object TimeCreated -Descending | Select-Object -First 1
  $changeTime = $last.TimeCreated
  $changeSrc  = "security_470x"
  W "change_time=$($changeTime.ToString('s')) change_src=$changeSrc last470x_id=$($last.Id) subj=$($last.Subject)"
} elseif ($db) {
  $changeTime = $db.LastWriteTime
  $changeSrc  = "secedit_sdb_fallback"
  W "change_time=$($changeTime.ToString('s')) change_src=$changeSrc"
} else {
  W "change_time=<unknown> change_src=<none>"
}

if ($changeTime) {
  $start = $changeTime.AddMinutes(-30)
  $end   = $changeTime.AddMinutes(30)
  W "window_start=$($start.ToString('s')) window_end=$($end.ToString('s'))"

  $secOut = @()
  try {
    $rawSec = Get-WinEvent -FilterHashtable @{
      LogName   = 'Security'
      StartTime = $start
      EndTime   = $end
      Id        = 4704,4705,4688
    } -ErrorAction Stop | Sort-Object TimeCreated

    foreach ($ev in $rawSec) {
      $x = [xml]$ev.ToXml()
      $d = @{}
      foreach($n in $x.Event.EventData.Data){ $d[$n.Name] = $n.'#text' }

      $subject = if($d.SubjectUserName){
        if($d.SubjectDomainName){"$($d.SubjectDomainName)\$($d.SubjectUserName)"} else {$d.SubjectUserName}
      } elseif($d.SubjectUserSid){ $d.SubjectUserSid } else { "" }

      $right = $d.UserRight
      if (-not $right) { $right = $d.PrivilegeList }

      $secOut += [pscustomobject]@{
        TimeCreated = $ev.TimeCreated
        Id          = $ev.Id
        Subject     = $subject
        Right       = $right
        ProcessName = $d.ProcessName
        CommandLine = $d.CommandLine
        FirstLine   = (($ev.Message -split "`n")[0]).Trim()
      }
    }

    if ($secOut.Count -gt 0) { $secOut | Export-Csv $secCsv -NoTypeInformation -Encoding UTF8 }
    W "security_count=$($secOut.Count) security_csv=$secCsv"
  } catch {
    W "security_query=fail err=$($_.Exception.Message)"
  }

  $taskOut = @()
  try {
    $rawTask = Get-WinEvent -FilterHashtable @{
      LogName   = 'Microsoft-Windows-TaskScheduler/Operational'
      StartTime = $start
      EndTime   = $end
    } -ErrorAction Stop | Sort-Object TimeCreated

    foreach ($ev in $rawTask) {
      $x = [xml]$ev.ToXml()
      $d = @{}
      foreach($n in $x.Event.EventData.Data){ $d[$n.Name] = $n.'#text' }

      $taskOut += [pscustomobject]@{
        TimeCreated = $ev.TimeCreated
        Id          = $ev.Id
        TaskName    = $d.TaskName
        ResultCode  = $d.ResultCode
        FirstLine   = (($ev.Message -split "`n")[0]).Trim()
      }
    }

    if ($taskOut.Count -gt 0) { $taskOut | Export-Csv $taskCsv -NoTypeInformation -Encoding UTF8 }
    W "task_count=$($taskOut.Count) task_csv=$taskCsv"
  } catch {
    W "task_query=fail"
  }

  $sysOut = @()
  try {
    $rawSys = Get-WinEvent -FilterHashtable @{
      LogName   = 'System'
      StartTime = $start
      EndTime   = $end
    } -ErrorAction Stop |
    Where-Object { $_.ProviderName -in 'Microsoft-Windows-GroupPolicy','SceCli','Service Control Manager' } |
    Sort-Object TimeCreated

    foreach($ev in $rawSys){
      $sysOut += [pscustomobject]@{
        TimeCreated = $ev.TimeCreated
        Id          = $ev.Id
        Provider    = $ev.ProviderName
        FirstLine   = (($ev.Message -split "`n")[0]).Trim()
      }
    }

    if ($sysOut.Count -gt 0) { $sysOut | Export-Csv $sysCsv -NoTypeInformation -Encoding UTF8 }
    W "system_count=$($sysOut.Count) system_csv=$sysCsv"
  } catch {
    W "system_query=fail"
  }
}

Set-Content -Path $lastPtr -Value $summary -Encoding ASCII

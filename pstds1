$l = "C:\temp\cleanup_sccm.log"
"--- START CLEANUP: $(Get-Date) ---" > $l
"Stopping processes..." >> $l
taskkill /F /IM ccmsetup.exe /T /EA 0 2>> $l
taskkill /F /IM ccmexec.exe /T /EA 0 2>> $l
"Deleting services..." >> $l
sc.exe delete CcmExec 2>> $l
sc.exe delete ccmsetup 2>> $l
"Cleaning WMI..." >> $l
Get-WmiObject -Namespace "root" -Query "Select * from __Namespace where Name='ccm'" | Remove-WmiObject -EA 0 2>> $l
"Removing folders..." >> $l
$flds = "C:\Windows\CCM", "C:\Windows\ccmsetup", "C:\Windows\ccmcache"
foreach ($f in $flds) {
    if (Test-Path $f) {
        Remove-Item $f -Recurse -Force -EA 0 2>> $l
        "Folder $f removed" >> $l
    }
}
"--- END CLEANUP: $(Get-Date) ---" >> $l
Write-Host "Cleanup finished. Check $l" -ForegroundColor Cyan






$l = "C:\temp\final_check.log"
"--- START FINAL VALIDATION: $(Get-Date) ---" > $l

# 1. Check if service still exists (The truth)
$svc = Get-Service CcmExec -ErrorAction SilentlyContinue
if ($svc) { 
    "ERROR: Service CcmExec still exists!" >> $l 
} else { 
    "SUCCESS: Service CcmExec is gone" >> $l 
}

# 2. Kill the Start Menu shortcut (The 'ghost')
$lnk = "$env:ProgramData\Microsoft\Windows\Start Menu\Programs\Software Center.lnk"
if (Test-Path $lnk) {
    Remove-Item $lnk -Force -EA 0
    "SUCCESS: Start Menu shortcut removed" >> $l
} else {
    "INFO: Shortcut already gone from disk" >> $l
}

"--- END VALIDATION ---" >> $l
Write-Host "Check $l to confirm the state." -ForegroundColor Cyan




$l = "C:\temp\force_remove.log"
"--- START FORCE REMOVAL: $(Get-Date) ---" > $l

# 1. Mata qualquer processo sobrevivente
taskkill /F /IM ccmexec.exe /T /EA 0 2>> $l

# 2. Deleta a chave do serviÃ§o no Registro (A marretada final)
if (Test-Path "HKLM:\SYSTEM\CurrentControlSet\Services\CcmExec") {
    reg delete "HKLM\SYSTEM\CurrentControlSet\Services\CcmExec" /f 2>> $l
    "SUCCESS: CcmExec Registry key deleted" >> $l
} else {
    "INFO: CcmExec Registry key not found" >> $l
}

# 3. Limpeza final de pasta
Remove-Item "C:\Windows\CCM" -Recurse -Force -EA 0 2>> $l

"--- END FORCE REMOVAL ---" >> $l
Write-Host "Limpeza de Registro concluida. Verifique $l" -ForegroundColor Cyan

$MinutesBack = 30
$TargetAccount = "YourServiceAccount"

Write-Host "Resolving SID for account: $TargetAccount" -ForegroundColor Cyan

try {
    $objUser = New-Object System.Security.Principal.NTAccount($TargetAccount)
    $TargetSid = $objUser.Translate([System.Security.Principal.SecurityIdentifier]).Value
    Write-Host "Target SID resolved: $TargetSid" -ForegroundColor Gray
}
catch {
    Write-Host "Error: Could not resolve SID for account $TargetAccount. Check spelling." -ForegroundColor Red
    break
}

Write-Host "Starting Security Event Audit..." -ForegroundColor Cyan

$StartDate = (Get-Date).AddMinutes(-$MinutesBack)

try {
    $RemovalEvents = Get-WinEvent -FilterHashTable @{LogName='Security'; ID=@(4704, 4718); StartTime=$StartDate} -ErrorAction Stop | Where-Object { $_.Message -like "*$TargetSid*" }
}
catch {
    Write-Host "No relevant security events found in the last $MinutesBack minutes." -ForegroundColor Green
    break
}

foreach ($Removal in $RemovalEvents) {
    $EventTime = $Removal.TimeCreated
    
    $xmlRem = [xml]$Removal.ToXml()
    $SubjectUser = ($xmlRem.Event.EventData.Data | Where-Object {$_.Name -eq 'SubjectUserName'}).'#text'
    $SubjectDomain = ($xmlRem.Event.EventData.Data | Where-Object {$_.Name -eq 'SubjectDomainName'}).'#text'
    $LogonId = ($xmlRem.Event.EventData.Data | Where-Object {$_.Name -eq 'SubjectLogonId'}).'#text'

    Write-Host "---------------------------------------------------"
    Write-Host "SECURITY EVENT DETECTED: ID $($Removal.Id)" -ForegroundColor Red
    Write-Host "Timestamp: $EventTime"
    Write-Host "Principal Identity: $SubjectDomain\$SubjectUser" -ForegroundColor Yellow
    Write-Host "Logon Session ID: $LogonId"
    
    $SearchStart = $EventTime.AddSeconds(-2)
    
    $ProcessEvents = Get-WinEvent -FilterHashTable @{LogName='Security'; ID=4688; StartTime=$SearchStart; EndTime=$EventTime} -ErrorAction SilentlyContinue | Sort-Object TimeCreated -Descending

    $ProcessMatched = $false

    if ($ProcessEvents) {
        foreach ($Process in $ProcessEvents) {
            $xml = [xml]$Process.ToXml()
            $ProcLogonId = ($xml.Event.EventData.Data | Where-Object {$_.Name -eq 'SubjectLogonId'}).'#text'
            
            if ($ProcLogonId -eq $LogonId) {
                $NewProc = ($xml.Event.EventData.Data | Where-Object {$_.Name -eq 'NewProcessName'}).'#text'
                $Parent = ($xml.Event.EventData.Data | Where-Object {$_.Name -eq 'ParentProcessName'}).'#text'
                
                Write-Host "   Executed Image: $NewProc" -ForegroundColor Cyan
                Write-Host "   Parent Process: $Parent"
                $ProcessMatched = $true
            }
        }
    }
    
    if (-not $ProcessMatched) {
        Write-Host "   No matching process creation event found for Logon ID $LogonId." -ForegroundColor Gray
    }
    Write-Host "---------------------------------------------------"
    Write-Host ""
}

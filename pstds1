$TimeFrameInDays = 30
$CutOffDate = (Get-Date).AddDays(-$TimeFrameInDays)

$SecurityEventIDs = 4704, 4705
$SystemContextEventIDs = 6005, 6006, 1500, 1501, 1000, 1001

Write-Host "--- 1. CORE TRACE: Searching Security Log for User Right Changes (4704/4705) ---" -ForegroundColor Yellow

$SecurityEventData = try {
    Get-WinEvent -LogName Security -FilterHashTable @{
        StartTime = $CutOffDate
        ID = $SecurityEventIDs
    } -ErrorAction Stop
}
catch {
    Write-Error "Error retrieving Security events. Ensure 'Audit Policy Change' is enabled."
    return
}

$CoreTraceEvents = $SecurityEventData | Where-Object {
    $_.Properties.Count -gt 3 -and ($_.Message -match "SeServiceLogonRight" -or $_.Message -match "SeBatchLogonRight")
} | Select-Object TimeCreated, ID, @{Name='ModifiedByPrincipal';Expression={$_.Properties[3].Value}}, @{Name='TargetAccount';Expression={$_.Properties[2].Value}}, @{Name='UserRight';Expression={$_.Properties[0].Value}}, Message

if ($CoreTraceEvents.Count -gt 0) {
    Write-Host "`nFOUND: Specific User Right Assignment/Removal Events." -ForegroundColor Green
    
    $CoreTraceEvents | Select-Object TimeCreated, ID, ModifiedByPrincipal, TargetAccount, UserRight, @{N='Action';E={
        if ($_.ID -eq 4704) {"ASSIGNED"}
        elseif ($_.ID -eq 4705) {"REMOVED"}
        else {"N/A"}
    }} | Sort-Object TimeCreated | Format-Table -AutoSize
}
else {
    Write-Host "`nNo 4704/4705 events found related to Service/Batch logon rights in the last $TimeFrameInDays days." -ForegroundColor Cyan
}

Write-Host "`n--- 2. CONTEXT TRACE: Searching System Log for GPO/System Events ---" -ForegroundColor Yellow

$SystemEventData = try {
    Get-WinEvent -LogName System -FilterHashTable @{
        StartTime = $CutOffDate
        ID = $SystemContextEventIDs
    } -ErrorAction Stop
}
catch {
    Write-Error "Error retrieving System events."
}

$ContextTraceEvents = $SystemEventData | Where-Object {
    $_.ID -in 6005, 6006 -or ($_.ProviderName -eq "Microsoft-Windows-GroupPolicy" -or $_.ProviderName -eq "SceCli")
} | Select-Object TimeCreated, ID, ProviderName, Message

if ($ContextTraceEvents.Count -gt 0) {
    Write-Host "`nFOUND: Relevant GPO and System Context Events." -ForegroundColor Green
    
    $ContextTraceEvents | Sort-Object TimeCreated | Format-Table TimeCreated, ID, ProviderName, @{N='MessageSummary';E={$_.Message.Split("`n")[0].Trim()}} -Wrap
}
else {
    Write-Host "`nNo GPO or System Startup context events found in the last $TimeFrameInDays days." -ForegroundColor Cyan
}

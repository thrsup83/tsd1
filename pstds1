$TimeFrameInDays = 30
$CutOffDate = (Get-Date).AddDays(-$TimeFrameInDays)
$LogonConfigIDs = 4704, 4705
$SystemStateIDs = 6005, 6006, 1500, 1501, 1000, 1001

Write-Host "--- Service Configuration Status Check ---" -ForegroundColor Gray

try {
    $ConfigEvents = Get-WinEvent -LogName Security -FilterHashTable @{StartTime=$CutOffDate; ID=$LogonConfigIDs} -ErrorAction Stop
} catch {
    $ConfigEvents = $null
}

if ($ConfigEvents) {
    $FilteredConfig = $ConfigEvents | Where-Object {
        $_.Properties.Count -gt 3 -and ($_.Message -match "SeServiceLogonRight" -or $_.Message -match "SeBatchLogonRight")
    } | Select-Object TimeCreated, ID, @{N='Source';E={$_.Properties[3].Value}}, @{N='Account';E={$_.Properties[2].Value}}, @{N='Policy';E={$_.Properties[0].Value}}

    if ($FilteredConfig) {
        $FilteredConfig | Select-Object TimeCreated, ID, Source, Account, Policy, @{N='State';E={if($_.ID -eq 4704){"Set"}else{"Unset"}}} | Sort-Object TimeCreated | Format-Table -AutoSize
    } else {
        Write-Host "No configuration changes detected." -ForegroundColor Gray
    }
} else {
    Write-Host "No configuration events found." -ForegroundColor Gray
}

Write-Host "`n--- System State Check ---" -ForegroundColor Gray

try {
    $StateEvents = Get-WinEvent -LogName System -FilterHashTable @{StartTime=$CutOffDate; ID=$SystemStateIDs} -ErrorAction Stop
} catch {
    $StateEvents = $null
}

if ($StateEvents) {
    $FilteredState = $StateEvents | Where-Object {
        $_.ID -in 6005, 6006 -or ($_.ProviderName -eq "Microsoft-Windows-GroupPolicy" -or $_.ProviderName -eq "SceCli")
    } | Select-Object TimeCreated, ID, ProviderName, @{N='Details';E={$_.Message.Split("`n")[0].Trim()}}

    if ($FilteredState) {
        $FilteredState | Sort-Object TimeCreated | Format-Table -AutoSize
    } else {
        Write-Host "No state events found." -ForegroundColor Gray
    }
} else {
    Write-Host "System log data unavailable." -ForegroundColor Gray
}

$svcName = "CbDefense"

Write-Host "`n[1/7] Service status"
try {
  Get-Service -Name $svcName | Select-Object Name, Status, StartType | Format-List
} catch {
  Write-Host "Service not found via Get-Service: $svcName"
}

Write-Host "`n[2/7] Service details (CIM)"
$wmi = Get-CimInstance Win32_Service -Filter "Name='$svcName'" -ErrorAction SilentlyContinue
if ($wmi) {
  $wmi | Select-Object Name, DisplayName, State, StartMode, PathName, StartName | Format-List
} else {
  Write-Host "Service not found via Win32_Service: $svcName"
}

Write-Host "`n[3/7] Registry settings (Start / DelayedAutoStart / ImagePath / Dependencies)"
$regPath = "HKLM:\SYSTEM\CurrentControlSet\Services\$svcName"
if (Test-Path $regPath) {
  $p = Get-ItemProperty $regPath
  [pscustomobject]@{
    Start            = ('0x{0:X}' -f $p.Start)
    DelayedAutoStart = $p.DelayedAutoStart
    ImagePath        = $p.ImagePath
    ObjectName       = $p.ObjectName
    DependOnService  = ($p.DependOnService -join ", ")
  } | Format-List
} else {
  Write-Host "Registry key not found: $regPath"
}

Write-Host "`n[4/7] SC configuration (raw)"
cmd /c "sc qc $svcName"
cmd /c "sc qfailure $svcName"
cmd /c "sc qfailureflag $svcName"

Write-Host "`n[5/7] ServicesPipeTimeout"
$ctl = "HKLM:\SYSTEM\CurrentControlSet\Control"
try {
  Get-ItemProperty $ctl -Name ServicesPipeTimeout -ErrorAction Stop |
    Select-Object ServicesPipeTimeout | Format-List
} catch {
  Write-Host "ServicesPipeTimeout not set (Windows default)"
}

Write-Host "`n[6/7] Carbon Black services under \Confer\"
Get-CimInstance Win32_Service |
  Where-Object { $_.PathName -like '*\Confer\*' } |
  Select-Object Name, State, StartMode, PathName |
  Sort-Object Name |
  Format-Table -AutoSize

Write-Host "`n[7/7] Recent SCM events (last 48h)"
$since = (Get-Date).AddHours(-48)
Get-WinEvent -FilterHashtable @{LogName='System'; ProviderName='Service Control Manager'; StartTime=$since} |
  Where-Object { $_.Message -match 'CbDefense|Carbon Black|Confer|RepMgr|RepWSC' } |
  Select-Object TimeCreated, Id, LevelDisplayName, Message |
  Format-List
